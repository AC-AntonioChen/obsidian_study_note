## 总览
![image.png](https://picgo-1324195593.cos.ap-guangzhou.myqcloud.com/picgo/20250408002031.png)
## APT

APT (Annotation Processing Tool) 注解处理工具是Java提供的在**编译时**针对源代码内注解暴露开放点，进行额外处理。在源代码编译成字节码的过程中，编译器会首先把Source Code解析成抽象语法树AST，最终再编译成字节码。在这个过程中，APT可以根据注解，来对AST语法树进行修改，从而实现最终字节码的修改。以Lombok为例，在整个编译过程中，当遇到属于Lombok的注解时，编译器就会执行Lombok的Handler来实现功能增强。

## ASM & Javassit & CGLib
ASM是纯粹的对字节码按照java的规范就行字节码理解范畴内的进行修改操作，可以说门槛很高; Javassit则可以理解为是一个提供了对字节码操作API的框架，来简化字节码操作的门槛，让字节码操作像面向对象编程一样简单；因此，由想而知，ASM要比Javassit性能要好，为此，为了鱼和熊掌兼得，我们从ASM基础上又衍生出了CGLib，虽然功能没有ASM强悍，但使用相对简单了很多。

## Instrument

为支持字节码技术能对已加载的类进行操作，Java提供了JVMTI的接口，最常见的就是debug功能，其启动命令是：`-agentlib:jdwp=transport=dt_socket,address=7085,server=y,suspend=n`, 可以看到利用\`\`\`agentlib\`\`这个参数就能注入agent相关代码，从而进行插桩。

Agent技术提供了两种使用方式，一个是在启动的时候，正如前面的debug命令一样，在启动时添加`agentlib`参数，另一个则是在运行时动态attach的方式，通过 Attach API，将模块（jar 包）动态地 Attach 到指定进程 id 的 Java 进程内。为此，也提供了两个入口方法：

| 1   2 | public static void premain(String agentArgs, Instrumentation inst);   public static void agentmain(String agentArgs, Instrumentation inst); |
| --- | --- |

分别对应两种不同的启动方式，当启动的时候，则调用premain方法，当运行中attach的时候，则是调用agentmain方法.

最早的agent lib实现方式都是采用Native方式实现，即c/c++的方式，这对于Java开发者来说门槛很高，为此，从Java 5之后，提供了java语言实现的方式，即大名鼎鼎的Instrument包，启动参数是： -javaagent，例如Aspectj动态方式的运行命令是：`-javaagent:path/aspectjweaver.jar`。  
那么问题来了，JVMTI接口使用的是Native方式，那java是怎么运行JAVA语言实现的agent包呢？

这里用到了一个名叫instrument.so的动态链接库， 通过它我们实现了将JVMTI接口与instrument包的java接口得到了打通。即`-javaagent`命令相当于`-agentlib:instrument`。