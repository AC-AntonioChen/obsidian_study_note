## 缓存
### 缓存异常场景
#### 缓存穿透
指缓存数据在数据库和redis都没有，而用户却不断发起请求。这种情况会导致请求压力打到数据库。
##### 解决措施
（1）接口层做校验，拦截住明显非法的查询（例如id<=0）
（2）根据key从缓存和数据库都没有取到的数据，写该key - null的键值对到redis，并设置短缓存时间，防止短时间暴力攻击 
（3）布隆过滤器（基于多hash的数据结构，可以快速判断某个值是否一定不存在）

#### 缓存击穿
指一条缓存数据在redis没有，但在数据库有，一般是缓存数据过期的情况，此时大量并发请求打到数据库。
##### 解决方案
（1）热点数据支持缓存续期，每次访问时更新缓存有效期：- **数据的一致性，不是靠“过期时间”来保证的，而是靠“写操作时的删除动作”来保证的。**
 （2）重建缓存加互斥锁，当线程拿到缓存发现缓存不存在就会尝试加锁，拿到锁的线程去数据库查并重建缓存，其他争抢失败的线程进行睡眠循环重试


#### 缓存雪崩
指大量缓存数据同时过期
##### 解决方案
1、缓存数据的过期时间设置随机，防止大量数据同时过期
2、重建缓存加互斥锁，当有线程竞争成功拿到锁后，负责去数据库读数据 并重建redis缓存，其他线程失败后sleep一段时间，循环重试
### 缓存一致性
#### 缓存一致性保证思路
- 简单思路：以Redis过期时间兜底，更新mysql既可，不管redis。
- 双写思路：在更新mysql后，<u>删除</u>（不是更新）redis。这种方式仍然要设置redis 的key过期时间。这样删除的结果就不需要关注了，最终一致性可以保障。
- 异步订阅binlog：业务代码只负责更新 MySQL。通过**Canal**（只负责发送消息到消息队列，具体数据怎么处理要有单独的消费服务）等中间件伪装成 MySQL 的 Slave 节点，**订阅 MySQL 的 Binlog**。  
```
1. **为了解耦核心业务逻辑**：  
    当一个写操作需要同步更新 Redis、ES、MQ 等多个下游数据源时，代码耦合度太高。通过 Binlog 订阅，业务代码只需要写 MySQL，后续同步完全异步化，降低了系统的复杂度。
    
2. **复杂的数据聚合场景（宽表缓存）**：  
    有些 Redis 缓存的数据结构很复杂，可能需要 Join 多张 MySQL 表（比如商品详情页）。如果采用‘删缓存’策略，读请求回源时数据库压力太大。利用 Binlog 可以在后台异步计算好最新的 JSON 直接覆盖写入 Redis，实现**‘读操作零延迟’**。
    
3. **对‘缓存击穿’敏感的热点数据**：  
    也就是您提到的那个视频网站的例子。对于**超高并发的热点 Key**，如果直接‘删除缓存’，可能导致数据库瞬间崩溃。Binlog 方案可以实现**‘双写覆盖’**（直接更新 Redis 而不删除），保证缓存一直存在，从而保护数据库。
    

所以，它不仅仅是为了‘稳定数据’，更是为了解决**复杂异构同步**和**热点高可用**的问题。”
```
## 分布式锁
 分布式锁就是分布式场景下的锁，比如多台不同机器上的进程，去竞争同一项资源，就是分布式锁。
### 分布式锁的特点
（1）互斥性：只有一个竞争者能获得锁
（2）抗死锁性：避免锁因为异常永远不被释放。当一个竞争者在持有锁期间内因自身原因不能主动解锁，其持有的锁也会被兜底释放
（3）对称性：同一个锁的加锁和解锁者需要是同一个竞争者
（4）可靠性：需要有一定程度的异常处理能力和容灾能力
#### 分布式锁的实现
redis实现是应用最多的一种。
![image.png](https://picgo-1324195593.cos.ap-guangzhou.myqcloud.com/picgo/20251210000653.png)

- 使用value保障其他线程不会意外释放不属于自己线程的锁
- lua脚本保障获取锁 和 删除锁的这个操作整体的原子性
#### 可靠性保障
单机模式下，如果 Redis 节点挂掉：
- **服务不可用**：所有依赖锁的业务阻塞或报错。
- **锁丢失**：内存数据丢失，可能导致超卖或并发脏数据。
##### 方案1：主从容灾 + 哨兵模式 (High Availability)
###### 架构原理

- **主从复制 (Master-Slave)**：
    - Master 处理写请求（加锁）。
    - Slave 通过 RDB（全量）+ repl_buf（增量）或 AOF 同步数据。
- **哨兵 (Sentinel)**：
    - 监控 Master 状态。
    - Master 宕机后，自动选举一个 Slave 晋升为新 Master。
    - **解决痛点**：无需人工介入，自动化容灾。
    ![](https://picgo-1324195593.cos.ap-guangzhou.myqcloud.com/picgo/20251210191627.png)
