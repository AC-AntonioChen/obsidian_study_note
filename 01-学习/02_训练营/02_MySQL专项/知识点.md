### 事务隔离级别实现
#### ACID
1. **原子性 (Atomicity)**：要么成功要么失败。👉 **Undo Log** 保证。
    
2. **持久性 (Durability)**：断电也不丢数据。👉 **Redo Log** 保证。
    
3. **隔离性 (Isolation)**：并发互不干扰。👉 **MVCC + 锁** 保证（今天的重点）。
    
4. **一致性 (Consistency)**：最终目标，由上面三个共同保证。

#### 并发典型问题
1. **脏读 (Dirty Read)**：读到了你**还没提交**的数据。
2. **不可重复读 (Non-repeatable Read)**：在一个事务里，两次读同一个数据，结果**不一样**。
3. **幻读 (Phantom Read)**：在一个事务里，两次查询**记录数量**不一样。


#### 读视图 Read View 
- 每行数据库数据都有两个隐藏字段：trx_id（谁改的）和 roll_pointer（指向上一个版本的 Undo Log）。
Read View 包含四个关键信息：
    - m_ids：此刻活跃（未提交）的事务 ID 列表。
    - min_trx_id：活跃事务里最小的 ID。
    - max_trx_id：下一个应该分配的事务 ID
    - creator_trx_id：我自己的 ID。
    
1. **Read View 是什么**：内存里的**“可见性判断依据”**，不是查出来的表。
    
2. **Select 什么时候生成** Read View ：
    
    - **RC 级别**：**每次** Select 都生成新的（不论死活，只看最新）。
        
    - **RR 级别**：**第一次** Select 生成，后面一直复用。
        
3. **Update 不看 Read View**：Update 永远强制读取**最新**数据（当前读），跟 Read View 没关系。
#### 隔离级别
（1）读未提交 RU：直接读最新数据
（2）读已提交 RC：**每次**执行 Select 语句，都**重新生成**一个 Read View。（所以能看到别人刚提交的变化）
（3）可重复读 RR：**启动事务时**生成一个 Read View，**整个事务期间复用**它。（所以别人怎么改，我都只看最开始的快照）
（4）串行化 Serial：加读写锁，排队执行。最安全但最慢。

### Mysql的一行数据的存储结构
```
|------------------ 快递单 (行头) -----------------|--- 追踪器 ---|------- 货物 (真实数据) -------|
[变长字段长度列表] [NULL值列表] [记录头信息(5字节)] | [事务ID] [回滚指针] | [列1数据] [列2数据] [列3数据] ...
```
#### 行头
存储元数据，帮助数据库解析后面的真实数据。

**1. 变长字段长度列表 (Variable Length Field Length List)**

- **作用**：记录所有变长字段（如 VARCHAR, TEXT）的实际字节长度。
    
- **为什么需要**：因为数据区没有分隔符，数据库必须先读这里，才知道 VARCHAR 读到哪里结束。
    
- **存储方式**：**逆序存放**（倒着记）。
    
- **示例**：若列1 name 长 3 字节，job 长 5 字节，这里存的是 05 03。
    

**2. NULL 值列表 (NULL Bitmask)**

- **作用**：标记哪些列是 NULL。
    
- **机制**：使用 **位图 (Bitmap)**。
    
    - 1 代表该列是 NULL。
        
    - 0 代表该列有值。
        
- **空间占用**：按字节对齐（例如 1-8 个 NULL 列占 1 字节）。
    
- **关键点**：**如果某列标记为 NULL，它在后面的“真实数据区”就不占任何空间了。**
    

**3. 记录头信息 (Record Header)**

- 固定占用 5 字节，包含重要的系统标记：
    
    - delete_mask：**删除标记**。执行 DELETE 时只打标记，不立即物理删除。
        
    - next_record：**下一条记录的偏移量**。通过这个指针，页内数据形成一个**单向链表**。
#### 追踪器隐藏列
用户建表时不可见，但 MySQL 自动添加，用于实现事务和 MVCC。

- **DB_ROW_ID (6字节)**：行 ID。如果没有主键也没有唯一索引，MySQL 会用它生成聚簇索引。
    
- **DB_TRX_ID (6字节)**：**事务 ID**。记录是谁（哪个事务）最后修改了这行数据。
    
- **DB_ROLL_PTR (7字节)**：**回滚指针**。指向 Undo Log，用于找到这行数据修改前的旧版本（实现回滚和多版本读取）。
#### 真实数据
- **存储方式**：紧挨着存储，中间**无任何分隔符**。
    
- **解析逻辑**：
    
    - **定长字段**（如 INT, CHAR）：根据表定义直接读固定长度。
        
    - **变长字段**（如 VARCHAR）：先去查行头的“变长字段长度列表”，再截取对应字节。
        
    - **NULL 字段**：直接跳过（不在数据区存储）。